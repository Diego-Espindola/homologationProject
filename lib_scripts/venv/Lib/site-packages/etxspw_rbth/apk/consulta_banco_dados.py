## Este arquivo pode ser utilizado para encapsular todas as operações relacionadas à consulta de dados no banco de dados. 

"""
Conexão com o Banco de Dados:
    Estabelecer conexão com o banco de dados onde as informações estão armazenadas.
    Gerenciar credenciais de acesso ao banco de dados de forma segura.

Processamento de Resultados:
    Receber os resultados das consultas SQL e processá-los conforme necessário.
    Transformar os resultados em estruturas de dados adequadas para serem manipuladas pelo restante do sistema.

Gerenciamento de Erros de Banco de Dados:
    Implementar lógica para lidar com exceções e erros que possam ocorrer durante as consultas ao banco de dados.
    Registrar e/ou reportar erros de forma adequada para manutenção e troubleshooting.
"""


# Contém funções para consultar o banco de dados e retornar os dados das matrículas.
# Gerencia conexões e executa consultas SQL para buscar as informações desejadas.

from pyodbc import connect
from SQLs import cargos, enderecos, eventos, matriculas, dependentes
import pandas as pd
import time

def get_data_frame(sql, odbc):
    """Função para executar uma query SQL usando a conexão ODBC especificada."""
    #conexao = connect(f'DSN={odbc}', ConnectionIdleTimeout=0)
    connection_string = (
        f"DSN={odbc};"
    )
    conexao = connect(connection_string, ConnectionIdleTimeout=0)
    cursor = conexao.cursor()
    cursor.execute(sql)
    df = pd.DataFrame.from_records(cursor.fetchall(), columns=[col[0] for col in cursor.description])
    cursor.close()
    return df

def consulta_cargo_tce(execucaoPrincipal):
    """Funcao que faz a busca dos cargos e suas respectivas informações do TCE e retorna um Data Frame"""
    sql = cargos.sql_cargo_tce(execucaoPrincipal)
    cargos_df = get_data_frame(sql, execucaoPrincipal.odbc)
    return cargos_df

def consulta_enderecos(execucaoPrincipal):
    sql = enderecos.sql_enderecos(execucaoPrincipal)
    enderecos_df = get_data_frame(sql, execucaoPrincipal.odbc)
    return enderecos_df

def consulta_eventos(execucaoPrincipal):
    sql = eventos.sql_eventos
    eventos_df = get_data_frame(sql, execucaoPrincipal.odbc)
    eventos_df['id'] = eventos_df['id'].astype(int)
    return eventos_df

def consulta_matriculas(execucaoPrincipal):
    sql = matriculas.sql_matriculas(execucaoPrincipal)
    matriculas_df = get_data_frame(sql, execucaoPrincipal.odbc)
    return matriculas_df

def consulta_dependentes(execucaoPrincipal):
    sql = dependentes.sql_dependentes(execucaoPrincipal)
    dependentes_df = get_data_frame(sql, execucaoPrincipal.odbc)
    dependentes_df = dependentes_df.drop('sistema', axis=1)
    return dependentes_df